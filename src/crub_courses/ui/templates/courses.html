{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-3">
                <i class="fas fa-book me-2"></i>
                Catálogo de Materias
            </h1>
            <p class="text-muted">
                Listado completo de materias y sus equipos docentes
            </p>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filtros
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" action="/courses">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="department" class="form-label">Departamento</label>
                                <select class="form-select" id="department" name="department">
                                    <option value="">Todos los departamentos</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>
                                        {{ dept }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="period" class="form-label">Período</label>
                                <select class="form-select" id="period" name="period">
                                    <option value="">Todos los períodos</option>
                                    {% for period in periods %}
                                    <option value="{{ period.value }}" {% if selected_period == period.value %}selected{% endif %}>
                                        {{ period.value }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="career" class="form-label">Carrera</label>
                                <select class="form-select" id="career" name="career">
                                    <option value="">Todas las carreras</option>
                                    {% for career in careers %}
                                    <option value="{{ career }}" {% if selected_career == career %}selected{% endif %}>
                                        {{ career }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="fas fa-search me-1"></i>Filtrar
                                    </button>
                                    <a href="/courses" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>Limpiar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Se encontraron <strong>{{ courses|length }}</strong> materias
                {% if selected_department or selected_period or selected_career %}
                con los filtros aplicados
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Courses List -->
    <div class="row">
        {% for course in courses %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong class="text-primary">{{ course.cod_siu }}</strong>
                    <span class="badge bg-secondary">{{ course.periodo.value }}</span>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ course.materia }}</h6>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-building me-1"></i>{{ course.department or 'Sin departamento' }}
                        </small>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="fas fa-graduation-cap me-1"></i>{{ course.carrera }}
                        </small>
                    </div>

                    <div class="mb-3">                    <div class="d-flex justify-content-between text-sm">
                        <span><i class="fas fa-users me-1"></i>Equipo: {{ course.total_team_size }}</span>
                        <span><i class="fas fa-user-tie me-1"></i>Responsables: {{ course.team_members|selectattr("rol.value", "equalto", "Resp")|list|length if course.team_members else 0 }}</span>
                    </div>
                    </div>

                    {% if course.team_members %}
                    <div class="mb-3">
                        <small class="text-muted d-block mb-1">Equipo docente:</small>
                        {% for member in course.team_members[:3] %}
                        <div class="badge bg-light text-dark me-1 mb-1">
                            {{ member.docente.split(',')[0] if ',' in member.docente else member.docente }}
                            <small>({{ member.rol.value }})</small>
                        </div>
                        {% endfor %}
                        {% if course.team_members|length > 3 %}
                        <div class="badge bg-secondary">
                            +{{ course.team_members|length - 3 }} más
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="/course/{{ course.cod_siu }}/{{ course.periodo.value }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver detalles
                    </a>
                    {% if course.huayca_data %}
                    <span class="badge bg-success ms-2">
                        <i class="fas fa-check me-1"></i>Huayca
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not courses %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <i class="fas fa-search me-2"></i>
                No se encontraron materias con los filtros aplicados.
                <br>
                <a href="/courses" class="btn btn-outline-primary mt-2">
                    Ver todas las materias
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
